<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>ddmo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
 </head>

  <body>
  <!-- The core Firebase JS SDK is always required and must be listed first -->



  <script>
      (function(d, s, id){
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {return;}
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/messenger.Extensions.js";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'Messenger'));

    const APP_ID = 544769076153407;    
    var senderID = "";
    
    window.extAsyncInit = function() {
        MessengerExtensions.getContext(APP_ID, 
          function success(thread_context){
           senderID = thread_context.psid;
          },
          function error(err){
            console.log(err);
          }
        );        
    };
  </script>
  
	<h1><%= title %></h1>

  <form id="form" enctype="multipart/form-data" method="post" action="https://fbstarter.herokuapp.com/webview/">
  <div class="form-group">
    <label for="name">Name</label>
    <input type="text" class="form-control" id="name" name="name" placeholder="Enter name">    
  </div>
  <div class="form-group">
    <label for="email">Email</label>
    <input type="email" class="form-control" id="email" name="email" placeholder="Email">
  </div> 
  <div class="form-group">
    <label for="email">Image</label>
    <input type="file" name="file" />
  </div>
  <input type="hidden"  id="sender" name="sender" value="<%= sender_id %>">
  <input type="submit" value="Submit"> 
  </form>


	
  <script>
      
   
      const windowShut = () => {
        setTimeout(() => { 
          MessengerExtensions.requestCloseBrowser(function success() {
            console.log("success");          
          }, function error(err) {
            console.log(err);
          });

        }, 3000);

        
      }

      
          

      /*
      const postFormData = (data) => {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "https://fbstarterbot.herokuapp.com/webview/", true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(data)); 
      } */

     

  </script>

  <script src="https://www.gstatic.com/firebasejs/7.19.0/firebase-app.js"></script>

  <!-- TODO: Add SDKs for Firebase products that you want to use
       https://firebase.google.com/docs/web/setup#available-libraries -->

  <script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyAxfR10CpQneRoa7TCLGWuVPNrAQ77YLvU",
      authDomain: "sample-project-2c26a.firebaseapp.com",
      databaseURL: "https://sample-project-2c26a.firebaseio.com",
      projectId: "sample-project-2c26a",
      storageBucket: "sample-project-2c26a.appspot.com",
      messagingSenderId: "238927004031",
      appId: "1:238927004031:web:378de536d056d255cd9a4a"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);



    function saveImage(){
      var storage = firebase.storage();
        var imgStorage = storage.ref();
        var imgRef = imgStorage.child(`items/${document.getElementById('FileLabel').innerHTML}`);
        var file = document.getElementById('img');
        imgRef.put(file.files[0]).then(function(putReturn){
          imgRef.getDownloadURL().then(function(imgURL) {
            
                window.location.assign('https://www.messenger.com/closeWindow/?image_url=https://image.shutterstock.com/image-vector/thankyou-word-text-handwritten-rainbow-260nw-1319893574.jpg&display_text=Thankyou')
            
          })
        })
    }

    document.getElementById("form").addEventListener("submit", saveImage());   
        
  </script>

  </body>

</html>